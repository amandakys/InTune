{% extends "intune/base_layer.html" %}
{% load staticfiles %}
{% load bootstrap3 %}

{% block title %}<title>{{ composition }}: Edit</title>{% endblock title %}

{% block imports %}
<meta charset="utf-8">
<link rel="stylesheet" type="text/css"
      href="{% static 'intune/composition_edit.css' %}">
<script src="{% static 'lib/vextab-div.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.2.1/lodash.js"></script>
<script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
<script src="{% static 'scripts/csrf.js' %}"></script>
<script src="{% static 'scripts/render.js' %}"></script>
<script src="{% static 'scripts/editor.js' %}"></script>

<script type="text/javascript">
<!-- Rendering and edit box -->
current_bar = -1;
var vt = VexTabDiv;
var VexTab = vt.VexTab;
var Artist = vt.Artist;
var Renderer = vt.Flow.Renderer;

var artist = new Artist(0, 0, 200);
var vextab = new VexTab(artist);

function edit_bar(bar_id) {
    $("#edit_text").val($("#render_" + bar_id).val());
    $('label[for="edit_text"]').html("Bar " + (bar_id + 1));
    current_bar = bar_id;
}

function render(bar_id, from_edit) {
    try {
        vextab.reset();
        artist.reset();
        var renderer = new Renderer($('#canvas_bar_' + bar_id)[0], Renderer.Backends.CANVAS);
        var stave = "tabstave notation=true tablature = false";
        if (bar_id > 0) { stave += " clef=none"; }
        var source = from_edit ? '#edit_text' : ('#render_' + bar_id);
        vextab.parse(stave + "\nnotes " + $(source).val());
        artist.render(renderer);
        $("#edit_error").text("");
    } catch (e) {
        console.log(e);
        $("#edit_error").html(e.message.replace(/[\n]/g, "<br/>"));
    }
}

function render_edit() {
    if (current_bar >= 0)
        render(current_bar, true);
}

$(function () {
    $("#edit_text").keyup(_.throttle(render_edit, 250));
    render_edit();
});
</script>

<script type="text/javascript">
<!-- Saving -->
function add_bar() {
    $.ajax({
        method: "POST",
        url: "{% url 'intune:bar_add' composition.id %}",
        dataType: "json",
        encode: true,
    });
    // TODO: add dynamically instead of reloading
    location.reload();
}

$(function () {
    $('#edit_form').submit(function(event) {
        if (current_bar < 0 || current_bar >= {{ composition.get_bar_list| length }}) {
            // Verify valid bar
            $("#save_error").html("Please select a bar to edit");
        } else if ($("#edit_error").html().length > 0) {
            // Verify no compile errors
            $("#save_error").html("Can't save invalid bar");
        } else {
            // Specify the bar, composition id
            var form_data = {
                'composition_id': {{ composition.id }},
                'bar_id': current_bar,
                'bar_contents': $("#edit_text").val(),
            };
            // Submit
            $.ajax({
                type: $('#edit_form').attr('method'),
                url: $('#edit_form').attr('action'),
                data: form_data,
                dataType: "json",
                encode: true,
            }).done(function(result) {
                console.log(result);
            });
        }
        event.preventDefault();
    });
});
</script>

{% endblock imports %}

{% block content %}

{# --- Editor Navigation --- #}

<div class="container">
    <div class="row justify-content-between">
        <div class="col-sm-6">
            <a href="{% url 'intune:index' %}" class="btn btn-default pull-left">Back</a>
            <a href="{% url 'intune:song' composition.id %}" class="btn btn-default">View Composition</a>
        </div>
        <div class="col-sm-6">
            <div class="dropdown pull-right">
                {# Sharing Composition #}
                {% if composition.owner.user == request.user %}
                <button type="button" class="btn btn-default dropdown-toggle"
                        id="share_button" data-toggle="dropdown"
                        aria-haspopup="true" aria-expanded="false">
                    Share
                <span class="caret"></span>
                </button>
                {% endif %}

                <div class="dropdown-menu" aria-labelledby="share_actions">
                    <form method="post" action="">
                        {% csrf_token %}
                        <div class="edit_users">
                            <h6 class="container">Add/Remove shared users:</h6>
                            {{ form.users }}
                        </div>
                        <div class="container">
                            <button type="submit" class="btn btn-default">
                                Save
                            </button>
                        </div>
                    </form>
                </div>

                {# Print Composition #}
                <button type="button" class="btn btn-default"
                        onclick="window.print();return false;">
                    Print sheets
                </button>
            </div>
        </div>
    </div>
</div>


<div class="container">
    <div class="row">
        <h1>{{ composition.title }}</h1>
    </div>
</div>

{# --- Canvas/Render Block --- #}

<div class="container text-center">
    <div class="row">
        <div class="canvas-block" id="render_block">
        </div>
    </div>

    <div class="row">
    {% for bar in composition.get_bar_list %}
        <canvas id="canvas_bar_{{ forloop.counter0 }}" onclick="edit_bar({{ forloop.counter0 }})"></canvas>
        <input type="text" style="display: none;" id="render_{{ forloop.counter0 }}" value="{{ bar }}"/>
        <script>
            render({{ forloop.counter0 }}, false);
        </script>
    {% endfor %}
    </div>
</div>


{# --- Main Editor interface --- #}
{# Left Column #}
<div class="row">
<div class="col-md-2 text-center">
    <div class="btn-group-vertical" role="group"
         aria-label="Left Editor Buttons">
        <button type="button" class="btn btn-default">Octave Change
        </button>
        <button type="button" class="btn btn-default">Select Multiple
        </button>
    </div>
</div>

{# Center Column #}
<div class="col-md-8">
    <div class="container">
        <div class="row text-center">
            <div class="btn-group" role="group" aria-label="Notation Selection">
                {# Semibreve #}
                <button type="button" class="btn btn-default bravura">
                    &#xE1D2;
                </button>
                {# Minim #}
                <button type="button" class="btn btn-default bravura">
                    &#xE1D3;
                </button>
                {# Crotchet #}
                <button type="button" class="btn btn-default bravura">
                    &#xE1D5;
                </button>
                {# Quaver #}
                <button type="button" class="btn btn-default bravura">
                    &#xE1D7;
                </button>
                {# Semiquaver #}
                <button type="button" class="btn btn-default bravura">
                    &#xE1D9;
                </button>
                {# Dotted Note #}
                <button type="button" class="btn btn-default bravura">
                    &#xE1E7;
                </button>
                {# Rest #}
                <button type="button" class="btn btn-default bravura">
                    &#xE4E5;
                </button>
                {# Flat #}
                <button type="button" class="btn btn-default bravura">
                    &#xE260;
                </button>
                {# Double Flat #}
                <button type="button" class="btn btn-default bravura">
                    &#xE264;
                </button>
                {# Natural #}
                <button type="button" class="btn btn-default bravura">
                    &#xE261;
                </button>
                {# Sharp #}
                <button type="button" class="btn btn-default bravura">
                    &#xE262;
                </button>
                {# Double Sharp #}
                <button type="button" class="btn btn-default bravura">
                    &#xE263;
                </button>
            </div>
        </div>
    </div>
    <div class="row text-center">
        <form method="post" action="{% url 'intune:bar_edit' %}" id="edit_form">
            <label for="edit_text"></label>
            <input type="text" class="form-control dynamic-textbox" id="edit_text" width="200" maxlength="30" placeholder="Select a bar to begin editing" />
            <button type="submit" class="btn btn-primary">Save</button>
            <button type="button" class="btn btn-primary" onclick="add_bar()">Add Bar</button>
            <button type="button" class="btn btn-primary" onclick="new_bar()">New Bar</button>
            <div id="edit_error"></div>
            <div id="save_error"></div>
        </form>
    </div>
</div>

{# Right Column #}
<div class="col-md-2 text-center">
    <div class="btn-group-vertical" role="group"
         aria-label="Right Editor Buttons">
        <button type="button" class="btn btn-default">UP</button>
        <button type="button" class="btn btn-default">LEFT</button>
        <button type="button" class="btn btn-default">RIGHT
        </button>
        <button type="button" class="btn btn-default">DOWN</button>
    </div>
</div>
</div>


{# needed for autocomplete to work #}
{{ form.media }}

{% endblock content %}

{# --- Footer Navigation --- #}
{% block footer %}
    <footer class="footer">
        <div class="container footer-text">
            *Placeholder*
        </div>
        <div class="container footer-text">
            *Placeholder*
        </div>
        <div class="container footer-text">
            Notifications
        </div>
    </footer>
{% endblock footer %}
