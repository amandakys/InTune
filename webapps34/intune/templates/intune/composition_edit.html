{% extends "intune/music_score_wrapper.html" %}
{% load staticfiles %}

{% block imports %}
<script src="{% static 'lib/underscore-min.js' %}"></script>
<script src="{% static 'lib/vexflow-min.js' %}"></script>
<script src="{% static 'lib/vexflow-json.js' %}"></script>
{% endblock imports %}

{% block score %}
<script type="text/javascript">
  function render_vexflow(element_id, data, render_options) {
    var element = document.getElementById(element_id);
    var json = new Vex.Flow.JSON(data);
    if (render_options) {
        json.render(element, render_options);
    } else {
        json.render(element, data);
    }
  }
</script>

<div class="render col-sm-12">
    <form method="post" action="">
        {% csrf_token %}
        <textarea rows="20" cols="160" name="data" maxlength="10000" width="100%"
        id="id_data">{{ composition.data }}</textarea>
        <br>
        <button type="submit" class="btn btn-light">Save</button>
        <button type="button" onclick="rerender()" class="btn btn-light" style="margin-top:20px">Render</button>
    </form>


<br>

<div id="song-canvas" class="col-xs-12">
    <canvas id="rendered"></canvas>
</div>

<script type="text/javascript">
    function rerender() {

        var canvas = $("#rendered")[0];
        var renderer = new Vex.Flow.Renderer(canvas,
        Vex.Flow.Renderer.Backends.CANVAS);

        {# TODO: dynamic sizing according to browser size? #}
        renderer.resize(800, 250); // Resize and clear canvas

        var text = document.getElementById("id_data").value;
        var modified_json = eval("(" + text + ")");
        render_vexflow("rendered", modified_json);
    }
    window.onload = rerender(); // render on load initial state
</script>

{% endblock %}
