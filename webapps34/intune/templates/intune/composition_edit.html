{% extends "intune/base_layer.html" %}
{% load staticfiles %}
{% load bootstrap3 %}

{% block title %}<title>{{ composition }}: Edit</title>{% endblock title %}

{% block imports %}
<meta charset="utf-8">
<link rel="stylesheet" type="text/css"
      href="{% static 'intune/composition_edit.css' %}">
<script src="{% static 'lib/vextab-div.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.2.1/lodash.js"></script>
<script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
<script src="{% static 'scripts/csrf.js' %}"></script>
<script src="{% static 'scripts/render.js' %}"></script>
<script src="{% static 'scripts/editor.js' %}"></script>
<script src="{% static 'scripts/comments.js' %}"></script>

{% endblock imports %}

{% block content %}

{# --- Editor Navigation --- #}

<div class="container">
    <div class="row justify-content-between">
        <div class="col-sm-6 pull-left">
            <a href="{% url 'intune:index' %}" class="btn btn-default">Back</a>
            <a href="{% url 'intune:song' composition.id %}" class="btn btn-default">View Composition</a>
        </div>
        <div class="col-sm-6">
            <div class="dropdown pull-right">
                {# Sharing Composition #}
                {% if composition.owner.user == request.user %}
                <button type="button" class="btn btn-default dropdown-toggle"
                        id="share_button" data-toggle="dropdown"
                        aria-haspopup="true" aria-expanded="false">
                    Share
                <span class="caret"></span>
                </button>
                {% endif %}

                <div class="dropdown-menu" aria-labelledby="share_actions">
                    <form method="post" action="">
                        {% csrf_token %}
                        <div class="edit_users">
                            <h6 class="container">Add/Remove shared users:</h6>
                            {{ form.users }}
                        </div>
                        <div class="container">
                            <button type="submit" class="btn btn-default">
                                Save
                            </button>
                        </div>
                    </form>
                </div>

                {# Print Composition #}
                <button type="button" class="btn btn-default"
                        onclick="window.print();return false;">
                    Print sheets
                </button>

                <button class="btn btn-default" id="chat-dropdown-toggle"
                        type="button">
                    <span class="glyphicon glyphicon-comment"></span>
                    <span class="caret"></span>
                </button>
                <div id="chat-dropdown" class="container dropdown">
                    <div class="dropdown-menu" id="chatbox-dropdown">
                        {% include "intune/chatroom.html" %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        <h1>{{ composition.title }}</h1>
        <div class="dropdown pull-right">
            <span class="glyphicon glyphicon-question-sign"
                class="dropdown-toggle"
                type="button"
                data-toggle="dropdown"
                style="cursor:help; font-size:20px"></span>
            <ul id="canvas-help-menu" class="dropdown-menu">
                <strong>What do the colours mean?</strong>
                <li><span class="render-error">Render error</span></li>
                <li><span class="selected">Currently selected bar</span></li>
                <li><span class="oth-user">Other users are editing that bar</span></li>
                <li>(changes made to that bar might be overwritten)</li>
            </ul>
        </div>
    </div>
</div>

{# --- Canvas/Render Block --- #}

<div class="container text-center">
    <div class="row">
        <div class="canvas-block" id="render_block" data-composition-id="{{ composition.id }}"
             data-ajax-target="{% url 'intune:composition_attribute' composition.id %}"
             data-user-id="{{ request.user.id }}">
        </div>
    </div>
</div>


{# --- Main Editor interface --- #}
<div class="row">

{# Center Column #}
<div class="col-md-8 col-md-offset-2">
    <div class="container">
        <div class="row text-center">
            <div class="btn-group" role="group" aria-label="Notation Selection">
                {# Semibreve #}
                <button type="button" class="notation-select btn btn-default" data-text=":w">
                    <span class="bravura">&#xE1D2;</span><span class="hint-text">(:w)</span>
                </button>
                {# Minim #}
                <button type="button" class="notation-select btn btn-default" data-text=":h">
                    <span class="bravura">&#xE1D3;</span><span class="hint-text">(:h)</span>
                </button>
                {# Crotchet #}
                <button type="button" class="notation-select btn btn-default" data-text=":q">
                    <span class="bravura">&#xE1D5;</span><span class="hint-text">(:q)</span>
                </button>
                {# Quaver #}
                <button type="button" class="notation-select btn btn-default" data-text=":8">
                    <span class="bravura">&#xE1D7;</span><span class="hint-text">(:8)</span>
                </button>
                {# Semiquaver #}
                <button type="button" class="notation-select btn btn-default" data-text=":16">
                    <span class="bravura">&#xE1D9;</span><span class="hint-text">(:16)</span>
                </button>
                {# Dotted Note #}
                <button type="button" class="notation-select btn btn-default" data-text="d">
                    <span class="bravura">&#xE1E7;</span><span class="hint-text">(d)</span>
                </button>
                {# Rest #}
                <button type="button" class="notation-select btn btn-default" data-text="##">
                    <span class="bravura">&#xE4E5;</span><span class="hint-text">(##)</span>
                </button>
                {# Flat #}
                <button type="button" class="notation-select btn btn-default" data-text="@">
                    <span class="bravura">&#xE260;</span><span class="hint-text">(@)</span>
                </button>
                {# Double Flat #}
                <button type="button" class="notation-select btn btn-default" data-text="@@">
                    <span class="bravura">&#xE264;</span><span class="hint-text">(@@)</span>
                </button>
                {# Natural #}
                <button type="button" class="notation-select btn btn-default" data-text="n">
                    <span class="bravura">&#xE261;</span><span class="hint-text">(n)</span>
                </button>
                {# Sharp #}
                <button type="button" class="notation-select btn btn-default" data-text="#">
                    <span class="bravura">&#xE262;</span><span class="hint-text">(#)</span>
                </button>
                {# Double Sharp #}
                <button type="button" class="notation-select btn btn-default" data-text="##">
                    <span class="bravura">&#xE263;</span><span class="hint-text">(##)</span>
                </button>
            </div>
        </div>
    </div>
    <div class="row text-center">
        <form method="post" action="{% url 'intune:bar_edit' %}" id="edit_form"
              data-composition-id="{{ composition.id }}">

            <label for="edit_text"></label>
            <input type="text" class="form-control input-lg dynamic-textbox"
                   placeholder="Select a bar to begin editing!" id="edit_text" />

            <div class="btn-group top-padded" role = "group" aria-label="bar modifications">
                <button type="submit" class="btn btn-default">Save</button>
                <button type="button" class="btn btn-default" id="new_bar">New Bar</button>
                <button type="button" class="btn btn-default" id="remove_bar">Remove Bar</button>
            </div>
            {# Error Messages to User #}
            <div id="edit_error"></div>
            <div id="save_error"></div>
        </form>
    </div>
</div>

{# Right Column #}
{# -- space for chatbox -- #}
<div class="col-sm-2">
</div>

{# -- Comments -- #}
<div class="container">
    <div class="row dropdown col-sm-12">
        <button style="margin-bottom: 1%"
                class="btn btn-dark dropdown-toggle"
                type="button" data-toggle="collapse"
                data-target="#comments-div">
            Comments (<span id="total-comments">Select a bar to show comments</span>)
            <span class="caret"></span>
        </button>
        <div class="collapse" id="comments-div">
            <form action="{% url 'intune:comment_create' %}" method="post" id="comment_form"
                class="form-inline" data-composition-id="{{ composition.id }}">
                {% csrf_token %}
                <input type="text" id="comment_text" class="form-control" placeholder="Write a comment" required/>
                {% buttons %}
                <button type="submit" class="btn btn-dark">Add Comment</button>
                {% endbuttons %}
            </form>
            <div id="comments"
                 data-room-id="{{ composition.id }}"
                 data-username="{{ user.username }}"
                 data-ajax-target="{% url 'intune:comments' %}"
                 data-user-id="{{ user.id }}">
            </div>
        </div>
    </div>
</div>

</div>

{# needed for autocomplete to work #}
{{ form.media }}

{% endblock content %}

{# --- Footer Navigation --- #}
{% block footer %}
    <footer class="footer">
        <div class="container footer-text">
            <button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#syntax_guide">
                Notation Guide
            </button>
        </div>
        <div class="container footer-text">
            <button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#symbol_table">
                Symbol Table
            </button>
        </div>
    </footer>

<!-- Modal -->
<div id="syntax_guide" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Notation Guide</h4>
            </div>

            <div class="modal-body">
                <p>
                    The text input for notes is based on
                    <a href="http://www.vexflow.com/vextab/" target="_blank">VexTab</a>.
                </p>
                <p>
                    Although it may seem daunting to read and understand the language, once you get the
                    basic understanding of it, VexTab is actually a very versatile language for
                    music notation.
                </p>
                <p>
                    The basic layout of the notation that make up a note comprises <u>two</u> parts:
                </p>
                <ol>
                    <li>Duration</li>
                    <li>Pitch</li>
                </ol>
                <p>
                    Duration is determined by a <i>base</i> duration - whole/half/quarter/etc
                    (represented by ":w"/":h"/":q"/...) - then followed by an optional "dot" (d)
                    modifier. So if you want a dotted minim, you would key in ":hd".
                </p>
                <p>
                    Pitch is also a two part component: classic letters "C", "D", "E", etc. or guitar tabs
                    (in "1", "2", etc.), followed by an octave number, separated by a "/".
                    For example, if I want a middle C (C4), I would type "C/4".
                </p>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div id="symbol_table" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Symbol Table</h4>
            </div>

            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Name</th>
                            <th>Text Representation</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td class="bravura-text large">&#xE1D2;</td>
                            <td>Whole Note / Semibreve</td>
                            <td>":w" or ":1"</td>
                        </tr>
                        <tr>
                            <td class="bravura-text large">&#xE1D3;</td>
                            <td>Half Note / Minim</td>
                            <td>":h" or ":2"</td>
                        </tr>
                        <tr>
                            <td class="bravura-text large">&#xE1D5;</td>
                            <td>Quarter Note / Crotchet</td>
                            <td>":q" or ":4"</td>
                        </tr>
                        <tr>
                            <td class="bravura-text large">&#xE1D7;</td>
                            <td>Quaver</td>
                            <td>":8"</td>
                        </tr>
                        <tr>
                            <td class="bravura-text large">&#xE1D9;</td>
                            <td>Semi-quaver</td>
                            <td>":16"</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock footer %}
